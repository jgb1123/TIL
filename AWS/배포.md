# 배포
* 스프링부트를 이용한 프로젝트를 배포하는 과정이다.
## EC2에 프로젝트 Clone 받기
* `sudo yum install git` EC2에 깃을 설치
* `git --version` 설치상태 확인
* `mkdir ~/app && mkdir ~/app/step1` clone으로 프로젝트를 저장할 디렉토리 생성
* `cd ~/app/step1` 생성된 디렉토리로 이동
* `git clone 복사한 https 주소` git clone 진행
* `cd 프로젝트명` 파일 잘 복사되었는지 확인
* `ll` 파일 잘 복사되었는지 확인
* `./gradlew test` 코드들이 잘 수행되는지 테스트
  * gradlew 실행 권한이 없다는 메시지가 뜨면 아래 명령어로 실행 권한을 추가한 뒤 다시 하면 된다.
  * `chmod +x ./gradlew`

## 배포 스크립트 만들기
* 간단한 배포 과정은 아래와 같다.
  * git clone 혹은 git pull을 통해 새 버전의 프로젝트를 받는다.
  * Gradle이나 Maven을 통해 프로젝트 테스트와 빌드를 한다.
  * EC2 서버에서 해당 프로젝트 실행 및 재실행을 한다.
* 하지만 이 과정들은 배포할 때마다 개발자가 하나하나 명령어를 실행해야 하는 불편함이 있다.
* 쉘 스크립트로 작성해 스크립트만 실행하면 앞의 과정이 차례대로 진행되도록 만들 수 있다.
  * 쉘 스크립트는 .sh라는 파일 확장자를 가진 파일로, 리눅스에서 기본적으로 사용할 수 있는 스크립트 파일의 한종류이다.
* `vim ~/app/step1/deploy.sh` deploy.sh 파일을 생성한다.
* 쉘 스크립트를 작성한다.
  ```shell
  #!/bin/bash
  
  REPOSITORY=/home/ec2-user/app/step1 # 프로젝트 디렉토리 주소 변수로 저장
  PORJECT_NAME=freelec-springboot2-webservice # 프로젝트 이름 변수로 저장
  
  cd $REPOSITORY/$PROJECT_NAME/ # git clone 받은 디렉토리로 이동
  
  echo "> Git Pull"
  
  git pull  # git pull 진행
  
  echo "> 프로젝트 Build 시작"
  
  ./gradlew build # gradlew로 build 진행
  
  echo "> step1 디렉토리로 이동"
  
  cd $REPOSITORY
  
  echo "> Build 파일 복사"
  
  cp $REPOSITORY/$PROJECT_NAME/build/libs/*.jar $REPOSITORY/ # 생성된 jar파일을, jar파일을 모아둔 위치로 복사
  
  echo "> 현재 구동중인 애플리케이션 pid 확인"
  
  CURRENT_PID=${pgrep -f ${PORJECT_NAME}.*.jar} # 기존에 수행중이던 애플리케이션 종료
  
  echo "> 현재 구동중인 애플리케이션 pid: $CURRENT_PID"
  
  if [ -z "$CURRENT_PID" ] then # 현재 구동 중인 프로세스가 있는지 없는지를 판단해 기능을 수행
    echo "> 현재 구동 중인 애플리케이션이 없으므로 종료하지 않습니다."
  else
    echo "> kill -15 $CURRENT_PID"
    kill -15 $CURRENT_PID
    sleep 5
  fi
  
  echo "> 새 애플리케이션 배포"
  
  JAR_NAME=$(ls -tr $REPOSITORY/ | grep jar | tail -n 1)  # 새로 실행할 jar파일명을 찾음
                                                          # 여러 jar파일이 생기기 때문에 tail -n로 가장 나중의 jar파일을 변수에 저장
  
  echo "> JAR Name: $JAR_NAME"
  
  nohub java -jar $REPOSITORY/$JAR_NAME 2>&1 &  # 찾은 jar 파일명으로 해당 jar 파일을 nohup으로 실행
                                                # 터미널 종료후에도 계속 애플리케이션이 구동될 수 있도록 nohup 명령어 사용
  ```
* `vim nohup.out` nohup.out 파일을 열어 로그를 본다.

### 외부 Security 파일 등록하기
* 일반적으로 위와 같이 그냥 진행 하면 properties 파일이 없기 때문에 실행에 실패한다.
* properites 파일은 보안적인 이유로 인해 .gitignore로 git에서 제외 대상이라 git에 올라가지 않기 때문이다.
* `vim /home/ec2-user/app/application-oauth.properties` properties 파일을 생성한다.
* 로컬에 있는 properties 파일 내용을 그대로 복사해 붙여넣고, 저장 후 종료한다. (`:wq`)
* deploy.sh 파일을 수정한다.
  ```shell
  ...
  nohub java -jar \
      -Dspring.config.location=classpath:/application.properties,/home/ec2-user/app/applicaton-oauth.properties \
      $REPOSITORY/$JAR-NAME 2>&1 &
  ```
  
