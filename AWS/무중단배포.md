# 무중단 배포
## 무중단 배포
* 예전에는 코드를 합치는 날과 배포를 하는 날을 정하고 진행했었다.
* 특히 배포일에는 사용자가 적은 새벽 시간에 개발자들이 모두 남아 배포 준비를 해야 했고, 배포 후 문제가 생기면 긴급점검 공지를 올리고 수정해야만 했다.
* 이렇게 서비스를 종료하고 배포해야 하는 경우 롤백조차 어렵고, 배포를 해야할때마다 서비스를 정지해야 하는 문제가 있었다. 
* 그래서 서비스를 정지하지 않고 배포할 수 있는 방법들을 찾아냈고, 이를 무중단 배포라고 한다.
### 엔진엑스(Nginx)
* 무중단 배포 방식은 여러가지가 있다.
  * AWS에서 블루 그린 무중단 배포
  * 도커를 이용한 웹서비스 무중단 배포
  * L4스위치를 이용한 무중단 배포(L4가 고가의 장비라 대형 인터넷 기업 외에는 쓸일이 없음)
* 그 외에도 엔진엑스(Nginx)를 이용한 방식이 있다.
  * 엔진엑스는 웹 서버, 리버스 프록시, 캐싱, 로드 밸런싱, 미디어 스트리밍 등을 위한 오픈소스 소프트웨어이다.
  * 아파치가 대세였던 자리를 빼았은 유명한 웹서버이고, 고성능 웹서버이기 때문에 대부분 서비스들이 엔진엑스를 사용한다.
* 엔진엑스의 여러 기능 중 리버스 프록시라는 기능이 있는데, 리버스 프록시는 엔진엑스가외부의 요청을 받아 백엔드 서버로 요청을 전달하는 행위를 의미한다.
  * 실제 요청에 대한 처리는 뒷단의 웹 애플리케이션 서버들이 처리한다.
* 이 리버스 프록시를 통해 무중단 배포 환경을 구축할 수 있고, 가장 저렴하고 쉬운 방법이다. (돈이 많으면 AWS 블루 그린 배포 방식을 사용하는게 좋음)

### 무중단 배포 방법(엔진엑스)
* 엔진엑스를 이용한 무중단 배포의 구조는 하나의 EC2 혹은 리눅스 서버에 엔진엑스 1대와 스프링 부트 Jar를 2대 사용하는 것이다.
  * 엔진엑스는 80(http), 443(https) 포트를 할당한다
  * 스프링 부트1은 8081포트로 실행한다.
  * 스프링 부트2은 8082포트로 실행한다.

#### 무중단 배포 1
* 사용자는 서비스 주소로 접속한다.(80포트 혹은 443포트)
* 엔진엑스는 사용자의 요청을 받아 현재 연결된 스프링 부트로 요청을 전달한다. (스프링 부트1로 전달한다고 가정)
* 스프링붙 2는 엔진엑스와 연결된 상태가 아니므로 요청받지 못한다.
* 만약 신규 배포가 필요하면 엔진엑스와 연결되지 않은 스프링 부트2로 배포한다.

#### 무중단 배포 2
* 배포하는 동안에 서비스는 중단되지 않는다.(엔진엑스는 스프링 부트1를 바라보는 중)
* 배포가 끝나고 정상적으로 스프링 부트2가 구동중인지 확인한다.
* 스프링 부트 2가 정상 구동 중이면 nginx reload 명령어를 통해 8081대신에 8082를 바라보도록 한다.
* nginx reload는 0.1초 이내에 완료된다.
* 이후 새로운 배포가 필요하면 이번엔 스프링 부트1로 배포한다.

#### 무중단 배포 3
* 현재는 엔진엑스와 연결된 것이 스프링 부트2이다.
* 스프링 부트1의 배포가 끝났으면 엔진엑스가 스프링 부트1을 바라보도록 변경하고 nginx reload를 실행한다.
* 이후 요청부터는 엔진엑스가 스프링 부트1로 요청을 전달한다.

## 엔진엑스 설치 및 스프링 부트 연결
### 엔진엑스 설치
* `sudo yum install nginx` 엔진엑스 설치
* `sudo service nginx start` 엔진엑스 실행

### 보안 그룹 추가
* 엔진엑스의 포트번호를 보안그룹에 추가한다.
* 엔진엑스의 포트번호는 기본적으로 80이다.
* EC2 -> 보안그룹 -> EC2 보안 그룹 선택 -> 인바운드 편집으로 이동하여 80번 포트번호를 보안그룹에 추가한다.

### 리다이렉션 주소 추가
* 8080이 아닌 80포트로 주소가 변경되니 소셜 로그인에도 변경된 주소를 등록해야만 한다.
* 기존에 등록된 리디렉션 주소에서 8080부분을 제거하여 추가 등록을 한다.
* EC2의 도메인으로 접근하되, 8080포트를 제거하고 접근해보면 엔진엑스 웹페이지를 확인할 수 있따.

### 엔진엑스와 스프링 부트 연동
* 엔진엑스가 현재 실행중인 스프링 부트 프로젝트를 바라볼 수 있도록 프록시 설정을 해야한다.
* `sudo vim /etc/nginx/nginx.conf` 엔진엑스 설정 파일 오픈
* 설정 내용 중 server아래의 `location /`부분을 찾아서 아래와 같이 수정한다.
```
location / {
    proxy_pass http://localhost:8080;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
}
```
* `:Wq` 저장 및 종료
* `sudo service nginx restart` 엔진엑스 재시작
* 브라우저로 접속해서 엔진엑스 시작 페이지가 보이면 화면을 새로고침한다.
* 엔진엑스가 스프링부트 프로젝트를 프록시 하는 것을 확인할 수 있다.

## 무중단 배포 스크립트 만들기
