# EC2
## AWS 사용 이유
* 외부에서 본인이 만든 서비스에 접근하려면 24시간 작동하는 서버가 필요한데, 아래와같은 3가지 방법이 있을 수 있다.
  * 개인 PC를 24시간 구동시킨다.
  * 호스팅 서비스(Cafe 24, 코리아호스팅 등)을 이용한다.
  * 클라우드 서비스(AWS, ZURE, GCP 등)을 이용한다.
* 일반적으로 비용은 호스팅 서비스나 개인 PC를 이용하는 것이 저렴하다.
* 하지만 특정 시간에만 트래픽이 몰린다면, 유동적으로 사양을 늘릴 수 있는 클라우드가 유리하다.
* 클라우드에서는 기본적으로 지원하는 기능(모니터링, 로그관리, 백업, 복구, 클러스터링 등)이 많아 개발에 좀 더 집중할 수 있게된다.
* 국내에서는 AWS 점유율이 압도적으로 높기 때문에, 사용자가 많아 국내 자료와 커뮤니티 또한 활성화되어 있다.

## 회원가입
* 회원가입에는 Master 혹은 Visa카드가 필요하다.
* AWS 공식 사이트에서 회원가입을 진행하면 된다.

## EC2 인스턴스 생성하기
* EC2는 AWS에서 제공하는 성능, 용량 등을 유동적으로 사용할 수 있는 서버로, AWS에서 리눅스 서버 혹은 윈도우 서버를 사용한다고 하면 이 EC2를 의미하는 것이다.
* 리전은 서울로 변경한다.

### AMI 선택
* AMI는 EC2 인스턴스를 시작하는데 필요한 정보를 이지미로 만들어 둔 것이다.
* 인스턴스라는 가상 머신에 운영체제 등을 설치할 수 있게 구워 넣은 이미지라고 생각하면 된다.
* 아직 국내 자료가 리눅스 1이 많기 때문에, 리눅스 1을 사용한다. (보통 센토스 6버전으로 진행되는 자료들은 아마존 리눅스 1에서 모두 사용 가능)
  * 아마존 리눅스 2는 센토스 7버전 자료들을 그대로 사용할 수 있다.
* 센토스 AMI대신 아마존 리눅스 AMI를 사용한 이유는 다음과 같다.
  * 아마존이 개발하고 있기 때문에 지원받기가 쉽다.
  * 레드햇 베이스이므로 레드햇 계열의 배포판을 많이 다뤄본 사람일수록 문제없이 사용할 수 있다.
  * AWS의 각종 서비스와의 상성이 좋다.
  * Amazon 독자적인 개발 리포지터리를 사용하고 있어 yum이 매우 빠르다.

### 인스턴스 유형 선택
* t2.micro는 프리티어이다.
  * t2는 요금 타입이며, micro는 사양을 의미한다.
  * t2 외에 t3도 있으며 보통 이것들을 T 시리즈라고 한다.
  * T 시리즈는 범용 시리즈로 불리기도 하며 다양한 사양을 사용할 수 있다.
* 다른 서비스와 달리 크레딧이란 일종의 CPU를 사용할 수 있는 포인트 개념이 있다.
* 인스턴스 크기에 따라 정해진 비율로 CPU 크레딧을 계속 받게 되며, 사용하지 않을 때는 크레딧을 축적하고, 사용할 때 이 크레딧을 사용한다.
* 정해진 사양보다 더 높은 트래픽이 오면 크레딧을 좀 더 적극적으로 사용하면서 트래픽을 처리하지만, 크레딧이 모두 사용되면 더이상 EC2를 사용할 수 없다.
* 따라서 트래픽이 높은 서비스들은 T 시리즈를 쓰지 않고 다른 시리즈를 사용하기도 하지만, 그 전까지는 활용도가 높기 때문에 시작하는 단계에서는 좋다.

### 세부 정보 구성
* 기업에서 사용할 경우 VPC, 서브넷 등을 세세하게 다뤄야 하지만, 혼자서 1대의 서버만 사용하면 별 다른 설정을 하지 않아도 된다.
* 대량의 서버를 사용하지 않는다면 굳이 별도로 구성할 필요가 없다.

### 스토리지
* 흔히 하드디스크라고 부르는 서버의 디스크를 의미하며, 서버의 용량을 얼마나 정할지 선택하는 단계다. 
* 프리티어는 30GB까지 지원한다.

### 태그
* 태그에는 웹 콘솔에서 표기될 태그인 Name 태그를 등록하면 된다.
* 태그는 해당 인스턴스를 표현하는 여러 이름으로 사용될 수 있으며, EC2의 이름을 붙인다고 생각하면 된다.

### 보안 그룹
* 보안 그룹은 방화벽을 의미한다.
* '서버로 80 포트 외에는 허용하지 않는다'는 역할을 하는 방화벽이 AWS에서는 보안 그룹으로 사용된다.
* 보안 그룹 이름엔 유의미한 이름으로 변경한다.
* 유형 항목에서 SSH이면서 포트 항목에서 22인 경우는 AWS EC2에 터미널로 접속할 때를 의미한다.
* pem 키가 없으면 접속이 안되니 전체 오픈(0.0.0.0/0, ::/0)하는 경우가 있는데, 이럴 경우 파일 공유 디렉토리나 깃허브 등에 실수로 pem 키가 노출되는 순간 서버에서 가상 화폐가 채굴되고 있을 수 있다.
* 보안은 언제나 높을수록 좋으니 pem 키 관리와 지정된 IP에서만 ssh 접속이 가능하도록 구성하는 것이 안전하다.
  * 예시로, 집의 IP를 기본적으로 추가하고, 집 외에 장소에서 접속할 때는 해당 장소의 IP를 다시 SSH 규칙에 추가하는 것이 안전하다.

### pem 키 선택
* 인스턴스로 접근하기 위해서는 pem 키(비밀키)가 필요하다.
* 인스턴스 마지막 단계는 할당할 pem 키를 선택하는 것이다.
* 인스턴스는 지정된 pem 키와 매칭되는 공개키를 가지고 있어, 해당 pem 키 외에는 접근을 허용하지 않는다.
* 일종의 마스터키이기 때문에 절대 유출되면 안되고, pem 키는 이후 EC2 서버로 접속할 때 필수 파일이니 잘 관리할 수 있는 디렉토리로 저장해야 한다.
* 만약 기존에 생성된 pem 키가 있다면 선택하면 되고, 없다면 신규로 생성하면 된다.

### 고정 IP 할당
* 인스턴스도 결국 하나의 서버이기 때문에 IP가 존재한다.
* 인스턴스 생성 시에 항상 새 IP를 할당하는데, 같은 인스턴스를 중지하고 다시 시작할 때도 새 IP가 할당된다.
* 인스턴스를 중지하고 다시 시작할때마다 IP가 변경되는데, 이러면 PC에서 접근할 때마다 IP 주소를 확인해야만 한다.
* 굉장히 번거로운 일이므로, 인스턴스의 IP가 매번 변경되지 않는 고정 IP를 가지게 해야한다.
* 방법은, EC2 인스턴스 페이지의 카테고리에서 탄력적 IP를 눌러 선택하고 새 주소 할당 버튼을 통해 새 주소를 할당하면 탄력적 IP가 발급된다.
* 인스턴스와 발급받은 탄력적 IP주소를 연결하기 위해, 주소 연결 메뉴에서 연결할 EC2 이름과 IP를 선택하면 된다.
* **주의할점은 탄력적 IP는 생성하고 EC2 서버에 연결하지 않으면 비용이 발생한다.**
* 따라서 생성한 탄력적 IP는 무조건 EC2에 바로 연결해야 하며, 더는 사용할 인스턴스가 없다면 탄력적 IP를 삭제해야 한다.

## EC2 서버에 접속하기(Linux)
* AWS와 같은 외부 서버로 SSH 접속을 하려면 매번 아래와 같은 긴 명령어를 입력해야 한다.
* `ssh -i pem 키 위치 EC2의 탄력적 IP 주소` 

* 이러한 문제를 해결할 수 있는 간편 설정이 있다.
  * 키페어 pem 파일을 ~/.ssh/ 로 복사한다.
  * ~/.ssh/ 디렉토리로 pem 파일을 옮겨 놓으면 ssh 실행 시 pem 키 파일을 자동으로 읽어 접속을 진행한다.
  * 별도로 pem 키 위치를 명령어로 지정할 필요가 없게 된다.
### 간편 설정 방법
* `cp pem 키를 내려받는 위치 ~/.ssh/` pem 키 복사
* `cd ~/.ssh/` 경로 이동
* `11` 파일목록 확인
* `chmod 600 ~/.ssh/pem키이름` pem 키 권한 변경
* `vim ~/.ssh/config` config 파일 생성 (아무런 확장자 없음)
  * ```
    Host 본인이 원하는 서비스 명
      HostName ec2의 탄력적 IP 주소
      User ec2-user
      IdentityFile ~/.ssh/pem키 이름
    ```
* `:wq` 저장 종료
* `chmod 700 ~/.ssh/config` config 파일 권한 변경
* `ssh config에 등록한 서비스 명` 접속
  * yes를 누르면 EC2에 접속이 성공한다.

## 아마존 리눅스 1 서버 생성시 설정
* 자바 기반의 웹 애플리케이션이 작동해야 하는 서버들이 필수로 해야하는 설정들이 있다.
### 자바 버전 변경
* 리눅스 1의 경우 기본 자바 버전이 7이기 때문에, 예시로 만약 자바 8을 쓴다면 아래와같은 명령어를 실행해야 한다.
  * `sudo yum install -y java-1.8.0-openjdk-devel.x86_64` 자바 8버전 설치
  * `sudo /usr/sbin/aternatives --config java` 인스턴스의 자바 버전 변경 (명령어 입력 후 버전 선택)
  * `sudo yum remove java-1.7.0-openjdk` 기존 자바 7 삭제
  * `java -version` 자바 버전 확인

### 타임존 변경
* EC2 서버의 기본 타임존은 UTC이기 때문에 한국시간(KST)로 변경해야 한다.
  * `sudo rm /etc/localtime`
  * `sudo ln -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime`
  * `date` 타임존 확인

### Hostname 변경
* 여러 서버를 관리 중일 경우, IP만으로 어떤 서비스의 서버인지 확인이 어렵다.
* 따라서 각 서버가 어느 서비스인지 표현하기 위해 HOSTNAME을 변경해야 한다.
  * `sudo vim /etc/sysconfig/network`
  * 화면에 나오는 항목 중 HOSTNAME으로 되어있는 부분을 원하는 서비스명으로 변경
  * `sudo reboot` 서버 재부팅
* 호스트 주소를 찾을 때 가장 먼저 검색해 보는 /etc/hosts에 변경한 hostname을 등록해야 한다.
  * `sudo vim /etc/hosts`
  * 화면에 `127.0.0.1 등록한HOSTNAME` 를통해 등록
  * `:wq` 저장 종료
  * `curl 등록한 호스트이름` 등록 확인
    * 잘못 등록되었으면 찾을 수 없는 주소라는 에러가 발생
    * 잘 등록되었으면 80포트로 접근이 안된다는 에러가 발생(호스트 이름으로 실행은 잘 되었음을 의미)

___
참고

이동욱, 스프링 부트와 AWS로 혼자 구현하는 웹 서비스